<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <script src="lib/lodash.js"></script>
        <script src="lib/jquery.min.js"></script>

        <script src="lib/backbone.js"></script>

        <script src="lib/d3.min.js"></script>

        <script src="lib/draggabilly.js"></script>
        <script src="lib/packery.js"></script>


        <script src="lib/leaflet/leaflet.js"></script>
        <link rel="stylesheet" href="lib/leaflet/leaflet.css">
        
        <link rel="stylesheet" href="lib/leaflet.markercluster/MarkerCluster.css">
        <link rel="stylesheet" href="lib/leaflet.markercluster/MarkerCluster.Default.css">
        <script src="lib/leaflet.markercluster/leaflet.markercluster.js"></script>


        <!-- xxxxxxxxxxxxxxxxxxxxxx -->

        <link rel="stylesheet" href="lib/fancybox/jquery.fancybox.css" type="text/css" media="screen" />
        <script type="text/javascript" src="lib/fancybox/jquery.fancybox.pack.js"></script>

        <!-- Add mousewheel plugin (this is optional) -->
        <!-- <script type="text/javascript" src="/fancybox/lib/jquery.mousewheel-3.0.6.pack.js"></script> -->


        <!-- Optionally add helpers - button, thumbnail and/or media -->
        <!-- <link rel="stylesheet" href="/fancybox/source/helpers/jquery.fancybox-buttons.css?v=1.0.5" type="text/css" media="screen" />
        <script type="text/javascript" src="/fancybox/source/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
        <script type="text/javascript" src="/fancybox/source/helpers/jquery.fancybox-media.js?v=1.0.6"></script> -->

        <!-- <link rel="stylesheet" href="/fancybox/source/helpers/jquery.fancybox-thumbs.css?v=1.0.7" type="text/css" media="screen" />
        <script type="text/javascript" src="/fancybox/source/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script> -->
        <!-- xxxxxxxxxxxxxxxxxxxxxx -->

        <link rel="stylesheet" href="search.base.css">
        <link rel="stylesheet" href="search.css">

    </head>

    <body>


        <div id="menu">

            <div id="query" class="query_expand">
                <div id="logo">

                </div>

                <div id="query_edit">

                    <input id="query_text" type="text" placeholder="Search"/>
                    <button id="query_update">&gt;</button>

                </div>
                <div id="query_map">

                </div>

                <div id="querySuggestionsWrapper">
                    <div id="query_suggestions" class="grid">
                    </div>
                </div>
            </div>

            <div id="facetsWrapper">
                <div id="facets" class="grid">
                </div>
            </div>
        </div>

        <div id="results">
        </div>

        <div id="focus" style="display:none">
        </div>



        <script>
            "use strict";

            function e(eleID) {
                return document.createElement(eleID);
            }
            function E(eleID) {
                return $(e(eleID));
            }

            function DIVclass(cssclass) {
                const x = $(e('div'));
                if (cssclass) {
                    x.attr('class', cssclass);
                }
                return x;
            }

            function newGrid(selector) {
                return selector.packery({});
            }

            function addToGrid(result, builder, grid) {

                var newItems = _.map(result, (v) => {

                    const c = builder(v);

                    return ($(e('div')).attr('class', 'grid-item').append(c))[0];

                });

                var nn = $(newItems);

                grid.append(nn).packery('appended', nn);

            }

            var app = {};

            $(document).ready(() => {

                var clusters = {};
                const active = new Map();

                function ResultNode(x) {
                    const y = DIVclass('list-item result');
                    y.data('o', x);

                    var tgt = x.I;
                    if (x.inh) {
                        x.out = x.inh['>'];

                        const vin = x.inh['<'];
                        if (vin && !(vin.length === 1 && vin[0].length === 0)) { //exclude root tag
                            x.in = vin;
                            tgt = vin;
                        }
                    }


                    if (clusters[tgt] === undefined) {
                        clusters[tgt] = [y];
                    } else {
                        clusters[tgt].push(y);
                    }


                    const header = DIVclass('header');
                    if (x.data) {
                        header.append(
                                //E('a').attr('href', x.data).attr('target', '_').append(
                                E('h2').text(x.N)
                                //)
                                );
                    } else {
                        header.append(
                                E('h2').text(x.N)
                                );

                    }

                    const meta = DIVclass('meta');


                    y.append(
                            header,
                            meta
                            );

                    if (x.thumbnail) {
                        const tt =
                                //E('a').attr('class', 'fancybox').attr('rel', 'group').append(
                                E('img').attr('src', "/thumbnail?I=" + x.thumbnail)
                                //)
                                ;
                        y.append(
                                tt
                                );

                        //http://fancyapps.com/fancybox/#examples
                        //tt.fancybox();
                    }

             

                    if (x['_']) {
                        y.append(E('p').attr('class', 'textpreview').html(x['_'].replace('\n', '<br/>')));
                    }


                    if (x.data) {
                        y.click(() => {
                            focus(x.data);
                        });
                    }


                    return y;

                }

                function ADD(f) {
                    var id = f.I;
                    if (!f || !id)
                        return null;

                    const prev = active.get(id);                   
                    if (prev) {
                        active.delete(id);
                        REMOVE(prev);
                    }


                    f.result = ResultNode(f);
                    $('#results').append(f.result);
                    
                    const bounds = f['@'];
                    if (bounds) {



                        //Leaflet uses (lat,lon) ordering but SpimeDB uses (lon,lat) ordering

                        //when = bounds[0]
                        var lon = bounds[1];
                        var lat = bounds[2];
                        //alt = bounds[3]

                        var label = f.N || id || "?";

                        var m;

                        var linePath, polygon;
                        if (linePath = f['g-']) {
                            //TODO f.lineWidth
                            m = L.polyline(linePath, {color: f.color || 'gray', data: f, title: label}).addTo(map);

                        } else if (polygon = f['g*']) {

                            m = L.polygon(polygon, {color: f.polyColor || f.color || 'gray', data: f, title: label}).addTo(map);

                        } else {
                            //default point or bounding rect marker:

                            var mm = {
                                        data: f,
                                        title: label,
                                        stroke: false,
                                        fillColor: "#0078ff",
                                        fillOpacity: 0.8,
                                        weight: 1
                                };

                            if (!(Array.isArray(lat) || Array.isArray(lon))) {
                                mm.zIndexOffset = 100;
                                //f.iconUrl
                                m = L.circleMarker( [ lat, lon ], mm).addTo(map);
                            } else {
                                var latMin = lat[0], latMax = lat[1];
                                var lonMin = lon[0], lonMax = lon[1];
                               

                                mm.opacity = 0.9; //TODO decrease this by the bounds area

                                m = L.rectangle([[latMin, lonMin], [latMax, lonMax]], mm).addTo(map);
                            }



                        }

                        if (m) {

                            m.on('click', clickHandler);
                            m.on('mouseover', overHandler);
                            m.on('mouseout', outHandler);

                            f.marker = m;

                        }
                    }


                    active.set(id, f);
                    return f;
                }


                function REMOVE(id) {

                    const r = active.get(id);
                    active.delete(id);                  
                    
                    if (!r)
                        return;

                    if (r.result) {
                        r.result.remove();
                        delete r.result;
                    }
                    
                    if (r.marker) {
                        r.marker.remove();
                        delete r.marker;
                    }
                    
                }

                function CLEAR() {
                    active.forEach((value, key) => {
                        REMOVE(key);
                    });
                    active.clear();
                    clusters = { };
                }


                $.get('/logo.html', (x) => {
                    $('#logo').html(x);
                });


                var map = L.map('query_map', {
                    continuousWorld: true,
                    worldCopyJump: true
                }).setView([51.505, -0.09], 2);

                //http://leaflet-extras.github.io/leaflet-providers/preview/
                L.tileLayer(
                        //'http://{s}.tile.osm.org/{z}/{x}/{y}.png'
                        'http://{s}.tile.opentopomap.org/{z}/{x}/{y}.png'
                        , {
                            //attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(map);

                //const mapClustering = new L.MarkerClusterGroup().addTo(map);
                
                var geojsonMarkerOptions = {
                     radius: 8,
                     fillColor: "#ff7800",
                     color: "#000",
                     weight: 1,
                     opacity: 1,
                     fillOpacity: 0.8
                 };
                
                function clickHandler(e) {
                    var obj = e.target.options.data;
                    if (obj.result) {
                        obj.result[0].scrollIntoView();                                               
                    }

                    /*var x = JSON.stringify(obj, null, 4);

                    var w = newWindow($('<pre>').text(x));
                    $.getJSON('/obj/' + obj.I, function(c) {
                         var desc = c['^']['_'];
                         if (desc)
                            w.html(desc);
                         else
                            w.html(JSON.stringify(c, null, 4));
                    } );*/
                }

                function overHandler(e) {
                    var o = e.target.options;
                                      
                    
                    /*if (o.ttRemove) {
                        clearTimeout(o.ttRemove);
                        o.tt.fadeIn();
                    }
                    else */{
                        if (o.tt) return; //already shown


                        $('.map2d_status').remove();
                        
                        //setTimeout(function () {
                            var tt = $('<div>').addClass('map2d_status');

                            tt.html($('<a>').text(o.title).click(function () {
                            }));

                            tt.css('left', e.containerPoint.x);
                            tt.css('top', e.containerPoint.y);

                            tt.appendTo($('#query_map'));
                            
                            o.tt = tt;
                        //}, 0);
                    }
                }
                
                function outHandler(e) {

                    var o = e.target.options;
                    if (o.tt) {
                        o.tt.remove();
                        delete o.tt;
                        /*
                        var delay = 1500; //ms
                        var fadeTime = 500; //ms
                        o.ttRemove = setTimeout(function() {
                            o.tt.fadeOut(fadeTime);
                            delete o.tt;
                            delete o.ttRemove;
                        }, delay);
                        */
                    }
                }                             
        
                const facets = newGrid($('#facets'));

                const queryText = $('#query_text');

                const qs = $('#query_suggestions');

                const onQueryTextChanged = _.throttle(() => {
                    const qText = queryText.val();
                    //$('#query_status').html('Suggesting: ' + qText);

                    $.get('/suggest', {q: qText}, function (result) {


                        if (result.length === 0) {
                            qs.html('');
                        } else {
                            qs.html(_.map(JSON.parse(result), (x) =>
                                DIVclass('grid-item').append(
                                        DIVclass('grid-item-content').text(x).click((e) => {
                                    queryText.val(x);
                                    update(x);
                                })
                                        )
                            ));
                        }
                    });
                }, 100, true, true);

                const querySubmit = () => {
                    update(queryText.val());
                };

                queryText.on('input', onQueryTextChanged);

                queryText.on('keypress', (e) => {
                    if (e.keyCode === 13)
                        querySubmit();
                });

                function scrollTop() {
                    $("body").scrollTop(0);
                }

                function expand() {
                    $('#menu').removeClass('sidebar');
                    $('#menu').addClass('expand');
                    $('#results').hide();

                    $('#facets .list-item').removeClass('list-item').addClass('grid-item');

                }

                function contract() {
                    unfocus();
                    $('#results').show().addClass('main');
                    $('#menu').removeClass('expand');
                    $('#menu').addClass('sidebar');

                    $('#facets .grid-item').removeClass('grid-item').attr('style', '').addClass('list-item');
                }

                function focus(url) {
                    Backbone.history.navigate("the/" + encodeURIComponent(url), {trigger: true});
                }

                function unfocus() {
                    $('#focus').hide();
                    $('#focus').html('');
                    $('#results').show();
                    $('#menu').removeClass('hide');
                    $('#results').removeClass('sidebar').removeClass('shiftdown');
                }

                function suggestionsClear() {
                    qs.html('');
                }

                function update(qText) {

                    Backbone.history.navigate("all/" + encodeURIComponent(qText), {trigger: true});

                }


                function loadFacets(result) {
                    facets.html('');

                    var facetButtonBuilder = (v) => {

                        const id = v[0]
                                .replace(/_/g, ' ')
                                .replace(/\-/g, ' ')
                                ; //HACK
                        const score = v[1];


                        const c = $(e('div'))
                                .attr('class', 'grid-item-content')
                                .text(id).click(() => {
                            queryText.val(/* dimension + ':' + */ id);
                            querySubmit();
                            return false;
                        })
                                .attr('style',
                                        'font-size:' + (75.0 + 20 * (Math.log(1 + score))) + '%');

                        return c;
                    };

                    addToGrid(result, facetButtonBuilder, facets);

                    //setTimeout(()=>{

                    setTimeout(() => {
                        facets.packery('layout');

                        setTimeout(() => {
                            facets.packery('layout');
                        }, 300);

                    }, 300);
                    //}, 0);
                }

                //PACKERY.js
                //http://codepen.io/desandro/pen/vKjAPE/
                //http://packery.metafizzy.co/extras.html#animating-item-size

                function updateFacet(dimension, label) {

                    const klass = label;

        //            $('#facets.' + klass).remove();
        //
        //            const f = $('<svg width="250" height="250">').attr('class', klass);//.html(label + '...');
        //            $('#facets').append($('<div>').append(f));

                    $.get('/facet', {q: dimension}, function (result) {
                        result = JSON.parse(result);

                        /*
                         f.html($('<div>').append(
                         $(d('h3')).text(label),
                         $(d('ul')).append(
                         _.map(result, (v) => {
                         return $(d('li')).append(d('a')).click(()=>{
                         queryText.val(dimension + ':' + id);
                         querySubmit();
                         }).text(id);
                         }))
                         ));
                         */

                        //BubblesFacetSVG(f, result);


                        loadFacets(result);


                    });

                }


                //START ----------------->

                app.Router = Backbone.Router.extend({

                    routes: {
                        "": "start",
                        "all/:query": "all",
                        "the/:query": "the"
                    },

                    the: function (url) {

                        suggestionsClear();

                        url = "/data?I=" + url;

                        $('#focus').attr('class', 'main').html(
                                E('iframe').attr('src', url).attr('width', '100%').attr('height', '100%')
                                );
                        $('#results').attr('class', 'sidebar shiftdown');
                        $('#menu').attr('class', 'hide');
                        $('#focus').show();

                    },

                    all: function (qText) {

                        suggestionsClear();

                        contract();

                        scrollTop();

                        //$('#query_status').html('').append($('<p>').text('Query: ' + qText));
                        $('#results').html('Searching...');

                        $.get('/search', {q: qText}, function (result) {

                            var ss, rr, ff;
                            try {
                                ss = JSON.parse(result);
                                rr = ss[0]; //first part: search results
                                ff = ss[1]; //second part: facets
                            } catch (e) {
                                //usually just empty search result
                                $('#results').html('No matches for: "' + qText + '"');
                                return;
                            }

                            contract();

                            loadFacets(ff);

                            $('#results').html('');
                            CLEAR();
                            _.forEach(rr, ADD);

                            _.each(clusters, (c, k) => {

                                if (c.length < 2)
                                    return; //ignore clusters of length < 2

                                const start = c[0];

                                const d = DIVclass('list-item result');
                                $(start).before(d);
                                c.forEach(cc => {
                                    /* {
                             
                                     d = cc;
                                     } else {
                                     children.push(cc);
                                     }*/
                                    cc.detach();
                                    cc.addClass('sub');
                                    if (cc.data('o').I !== k) //the created root entry for this cluster, ignore for now
                                        d.append(cc);
                                });

                                //HACK if there was only 1 child, just pop it back to top-level subsuming any parents
                                var dc = d.children();
                                if (dc.length == 1) {
                                    $(dc[0]).removeClass('sub');
                                    d.replaceWith(dc[0]);
                                }


                            });




                        });

                    },

                    start: function () {

                        facets.html('');

                        expand();

                        //updateFacet('I', 'Category');
                        updateFacet('>', 'Tag');


                    }


                });

                app.router = new app.Router();

                Backbone.history.start();

            }, false);

        </script>

    </body>

</html>
