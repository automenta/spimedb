<html>
<head>

    <script src="lib/lodash.js"></script>
    <script src="lib/jquery.min.js"></script>
    <script src="lib/tempo.js"></script>
    <link rel="stylesheet" href="search.css">
</head>
<body>

<div id="query">
    <div id="query_edit">
        <span>
            <input id="query_text" type="text" placeholder="Search"/>
            <button id="query_update">Search</button>
        </span>
    </div>
    <div id="query_status">
    </div>
    <div id="query_suggestions">
    </div>
</div>

<div id="facets">
</div>

<div id="query_results">
    <ul data-template class="result">

        <h2 data-template>{{N}}</h2>
        <a data-template data-has="data" href="" data-href="{{data}}">Download</a>

        <div class="meta">
            <span data-template data-has="in">+: {{in}}</span>
            <span data-template data-has="I">{{I}}</span>
            <span data-template data-has="out">-: {{out}}</span>
        </div>

        <div class="preview">
            <img data-template data-has="thumbnail" src="" data-src="{{thumbnail}}"/>
            <p data-template data-has="_">{{ _ | replace '\n', '<br>' }}</p>
        </div>

    </ul>
    <li data-template-fallback>JavaScript required</li>
</div>



</body>


<script>

    $(document).ready(()=>{

        const resultsTemplate = Tempo.prepare("query_results", {'escape': false});

        const queryText = $('#query_text');


        const onQueryTextChanged = _.throttle(()=>{
            const qText = queryText.val();
            $('#query_status').html('Suggesting: ' + qText);
            $.get('/suggest', { q: qText }, function(result) {

                if (result.length === 0) return;

                $('#query_suggestions').html(_.map(JSON.parse(result), (x) =>
                    $(document.createElement('div')).append(
                        $(document.createElement('a')).text(x).click((e)=>{ queryText.val(x); update(x);  } )
                    )
                ));
            });
        }, 100, true, true);

        const querySubmit = () => {
            update(queryText.val());
        };

        queryText.on('input', onQueryTextChanged);
        queryText.on('keypress', (e) => {
            if (e.keyCode === 13)
                querySubmit();
        });
        $('#query_update').click(querySubmit);


        function update(qText) {

            //$('#query_status').html('').append($('<p>').text('Query: ' + qText));

            $.get('/search', { q: qText }, function(result) {

                const rr = JSON.parse(result);

                _.each(rr, (v,k)=>{
                    if (v.inh) {
                        v.out = v.inh['<'];

                        const vin = v.inh['>'];
                        if (vin && !(vin.length === 1 && vin[0].length === 0)) //exclude root tag
                            v.in = vin;
                    }
                });
                resultsTemplate.render(rr);

            });
        }

        function d(eleID) {
            return document.createElement(eleID);
        }

        function updateFacet(dimension, label) {

            const klass = label;

            $('#facets.' + klass).remove();

            const f = $('<div>').attr('class', klass).html(label + '...');
            $('#facets').append( f );

            $.get('/facet', { q: dimension }, function(result) {
                result = JSON.parse(result);
                f.html($('<div>').append(
                    $(d('h3')).text(label),
                    $(d('ul')).append(
                        _.map(result, (v) => {
                            const id = v[0];
                            const score = v[1];
                            return $(d('li')).append(d('a')).click(()=>{
                                queryText.val(queryText.val() + ' ' + dimension + ':' + id);
                                querySubmit();
                            }).text(id);
                        }))
                ));
            });
        }

        updateFacet('I', 'Category');
        updateFacet('>', 'Tag');

    }, false );
</script>



</html>