<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="lib/lodash.js"></script>
    <script src="lib/jquery.min.js"></script>

    <script src="lib/d3.min.js"></script>

    <script src="lib/draggabilly.js"></script>
    <script src="lib/packery.js"></script>

    <link rel="stylesheet" href="search.base.css">
    <link rel="stylesheet" href="search.css">

</head>
<body>


<div id="query_results" class="grid">

</div>

<div id="menu">

    <div id="query">
        <div id="query_edit">
            <span>
                <input id="query_text" type="text" placeholder="Search"/>
                <button id="query_update">Search</button>
            </span>
        </div>

        <div id="querySuggestionsWrapper">
            <div id="query_suggestions" class="grid">
            </div>
        </div>
    </div>

    <hr/>

    <div id="facetsWrapper">
        <div id="facets" class="grid">

        </div>
    </div>
</div>


</body>


<script>
    "use strict";

    function e(eleID) {
        return document.createElement(eleID);
    }
    function E(eleID) {
        return $(e(eleID));
    }

    function DIVclass(cssclass) {
        const x = $(e('div'));
        if (cssclass) {
            x.attr('class', cssclass);
        }
        return x;
    }

    function draggabilify(gridItem, grid) {

        const draggie = new Draggabilly(gridItem);

        grid.packery('bindDraggabillyEvents', draggie);

        return gridItem;

    }

    function BubblesFacetSVG(f, result) {
        const svg = d3.select(f[0]),
            width = +svg.attr("width"),
            height = +svg.attr("height");

        var format = d3.format(",d");

        var color = d3.scaleOrdinal(d3.schemeCategory20c);

        var pack = d3.pack()
            .size([width, height])
            .padding(1.5);


        const root = d3.hierarchy({children: result})
            .sum(function (d) {
                return d[1];
            })
            .each(function (d) {
                d.id = d.data[0];
                d.value = Math.log(1 + d.data[1]);
            });

        const node = svg.selectAll(".node")
            .data(pack(root).leaves())
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", function (d) {
                return "translate(" + d.x + "," + d.y + ")";
            });

        node.append("circle")
            .attr("id", function (d) {
                return d.id;
            })
            .attr("r", function (d) {
                return d.r;
            })
            .style("fill", function (d) {
                return color(d.id);
            });

        node.append("clipPath")
            .attr("id", function (d) {
                return "clip-" + d.id;
            })
            .append("use")
            .attr("xlink:href", function (d) {
                return "#" + d.id;
            });

        node.append("text")
            .attr("clip-path", function (d) {
                return "url(#clip-" + d.id + ")";
            })
            .selectAll("tspan")
            .data(function (d) {
                return d.id.split(/(?=[A-Z][^A-Z])/g);
            })
            .enter().append("tspan")
            .attr("x", 0)
            .attr("y", function (d, i, nodes) {
                return 13 + (i - nodes.length / 2 - 0.5) * 10;
            })
            .text(function (d) {
                return d;
            });

        node.append("title")
            .text(function (d) {
                return d.id;// + "\n" + format(d.value);
            });
    }


    function newGrid(selector) {
        return selector.packery({});
    }

    function addToGrid(result, builder, grid) {

        var newItems = _.map(result, (v) => {

            const c = builder(v);

            return ( $(e('div')).attr('class', 'grid-item').append(c))[0];

        });

        var nn = $(newItems);

        grid.append(nn).packery('appended', nn);

        newItems.forEach((x) => draggabilify(x, grid));
    }


    $(document).ready(() => {

        const facets = newGrid($('#facets'));
        const results = newGrid($('#query-results'));

        //const resultsTemplate = Tempo.prepare("query_results", {'escape': false});

        const queryText = $('#query_text');

        const qs = $('#query_suggestions');

        const onQueryTextChanged = _.throttle(() => {
            const qText = queryText.val();
            //$('#query_status').html('Suggesting: ' + qText);

            $.get('/suggest', {q: qText}, function (result) {


                if (result.length === 0) {
                    qs.html('');
                } else {
                    qs.html(_.map(JSON.parse(result), (x) =>
                        DIVclass('grid-item').append(
                            DIVclass('grid-item-content').text(x).click((e) => {
                                queryText.val(x);
                                update(x);
                            })
                        )
                    ));
                }
            });
        }, 100, true, true);

        const querySubmit = () => {
            update(queryText.val());
        };

        queryText.on('input', onQueryTextChanged);

        queryText.on('keypress', (e) => {
            if (e.keyCode === 13)
                querySubmit();
        });

        $('#query_update').click(querySubmit);

        function update(qText) {

            //$('#query_status').html('').append($('<p>').text('Query: ' + qText));

            $.get('/search', {q: qText}, function (result) {

                var rr;
                try {
                    rr = JSON.parse(result);
                } catch (e) {
                    //usually just empty search result
                    return;
                }

                $('#query_results').html(
                    _.map(rr, (x, k) => {

                        if (!x.I)
                            return;

                        if (x.inh) {
                            x.out = x.inh['<'];

                            const vin = x.inh['>'];
                            if (vin && !(vin.length === 1 && vin[0].length === 0)) //exclude root tag
                                x.in = vin;
                        }

                        const header = DIVclass('header');
                        if (x.data) {
                            header.append(
                                E('a').attr('href', x.data).attr('target', '_').append(
                                    E('h2').text(x.N)
                                )
                            );
                        } else {
                            header.append(
                                E('h2').text(x.N)
                            );

                        }

                        const meta = DIVclass('meta');

                        const preview = DIVclass('preview');
                        if (x.thumbnail) {
                            preview.append(
                                E('img').attr('src', x.thumbnail)
                            );
                        }
                        if (x['_']) {
                            preview.append(E('p').html(x['_'].replace('\n', '<br/>')));
                        }


                        const y = DIVclass('grid-item result').append(
                            header,
                            meta,
                            preview
                        );


                        return y;
                    })
                );


                $("#query_results").scrollTop(0);


            });
        }


        //PACKERY.js
        //http://codepen.io/desandro/pen/vKjAPE/
        //http://packery.metafizzy.co/extras.html#animating-item-size

        function updateFacet(dimension, label) {

            const klass = label;

//            $('#facets.' + klass).remove();
//
//            const f = $('<svg width="250" height="250">').attr('class', klass);//.html(label + '...');
//            $('#facets').append($('<div>').append(f));

            $.get('/facet', {q: dimension}, function (result) {
                result = JSON.parse(result);

                /*
                 f.html($('<div>').append(
                 $(d('h3')).text(label),
                 $(d('ul')).append(
                 _.map(result, (v) => {
                 return $(d('li')).append(d('a')).click(()=>{
                 queryText.val(dimension + ':' + id);
                 querySubmit();
                 }).text(id);
                 }))
                 ));
                 */

                //BubblesFacetSVG(f, result);


                var facetButtonBuilder = (v) => {

                    const id = v[0]
                        .replace(/_/g, ' ')
                        .replace(/\-/g, ' ')
                    ; //HACK
                    const score = v[1];


                    const c = $(e('div'))
                        .attr('class', 'grid-item-content')
                        .text(id).click(() => {
                            queryText.val(dimension + ':' + id);
                            querySubmit();
                            return false;
                        })
                        .attr('style',
                            'font-size:' + (75.0 + 20 * (Math.log(1 + score))) + '%');

                    return c;
                };

                setTimeout(()=> addToGrid(result, facetButtonBuilder, facets), 0);


            });

        }

        //updateFacet('I', 'Category');
        updateFacet('>', 'Tag');

    }, false);

</script>


</html>