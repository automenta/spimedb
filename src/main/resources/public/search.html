<html>
<head>

    <script src="lib/lodash.js"></script>
    <script src="lib/jquery.min.js"></script>
    <script src="lib/tempo.js"></script>

    <script src="lib/d3.min.js"></script>

    <link rel="stylesheet" href="search.css">
</head>
<body>

<div id="query">
    <div id="query_edit">
        <span>
            <input id="query_text" type="text" placeholder="Search"/>
            <button id="query_update">Search</button>
        </span>
    </div>
    <div id="query_status">
    </div>
    <div id="query_suggestions">
    </div>
</div>

<div id="facets">
</div>

<div id="query_results">
    <div data-template class="result">

        <div class="header">
            <div style="width:100%"><h2 data-template>{{N}}</h2></div>
            <div><a data-template data-has="data" href="" data-href="{{data}}" target="_" title="Download"><h2>~</h2></a></div>
        </div>

        <div class="meta">
            <span data-template data-has="in">+: {{in}}</span>
            <span data-template data-has="I">{{I}}</span>
            <span data-template data-has="out">-: {{out}}</span>
        </div>

        <div class="preview">
            <img data-template data-has="thumbnail" src="" data-src="{{thumbnail}}"/>
            <p data-template data-has="_">{{ _ | replace '\n', '<br>' }}</p>
        </div>

    </div>
    <li data-template-fallback>JavaScript required</li>
</div>


</body>


<script>

    $(document).ready(() => {

        const resultsTemplate = Tempo.prepare("query_results", {'escape': false});

        const queryText = $('#query_text');


        const onQueryTextChanged = _.throttle(() => {
            const qText = queryText.val();
            $('#query_status').html('Suggesting: ' + qText);
            $.get('/suggest', {q: qText}, function (result) {

                if (result.length === 0) return;

                $('#query_suggestions').html(_.map(JSON.parse(result), (x) =>
                    $(document.createElement('div')).append(
                        $(document.createElement('a')).text(x).click((e) => {
                            queryText.val(x);
                            update(x);
                        })
                    )
                ));
            });
        }, 100, true, true);

        const querySubmit = () => {
            update(queryText.val());
        };

        queryText.on('input', onQueryTextChanged);
        queryText.on('keypress', (e) => {
            if (e.keyCode === 13)
                querySubmit();
        });
        $('#query_update').click(querySubmit);


        function update(qText) {

            //$('#query_status').html('').append($('<p>').text('Query: ' + qText));

            $.get('/search', {q: qText}, function (result) {

                const rr = JSON.parse(result);

                _.each(rr, (v, k) => {
                    if (v.inh) {
                        v.out = v.inh['<'];

                        const vin = v.inh['>'];
                        if (vin && !(vin.length === 1 && vin[0].length === 0)) //exclude root tag
                            v.in = vin;
                    }
                });
                resultsTemplate.render(rr);

            });
        }

        function d(eleID) {
            return document.createElement(eleID);
        }

        function updateFacet(dimension, label) {

            const klass = label;

            $('#facets.' + klass).remove();

            const f = $('<svg width="250" height="250">').attr('class', klass);//.html(label + '...');
            $('#facets').append($('<div>').append(f));

            $.get('/facet', {q: dimension}, function (result) {
                result = JSON.parse(result);

                /*
                 f.html($('<div>').append(
                 $(d('h3')).text(label),
                 $(d('ul')).append(
                 _.map(result, (v) => {
                 const id = v[0];
                 const score = v[1];
                 return $(d('li')).append(d('a')).click(()=>{
                 queryText.val(dimension + ':' + id);
                 querySubmit();
                 }).text(id);
                 }))
                 ));
                 */


                var svg = d3.select(f[0]),
                    width = +svg.attr("width"),
                    height =  +svg.attr("height");

                var format = d3.format(",d");

                var color = d3.scaleOrdinal(d3.schemeCategory20c);

                var pack = d3.pack()
                    .size([width, height])
                    .padding(1.5);



                var root = d3.hierarchy({children: result})
                    .sum(function (d) {
                        return d[1];
                    })
                    .each(function (d) {
                        d.id = d.data[0];
                        d.value = Math.log(1 + d.data[1]);
                    });

                var node = svg.selectAll(".node")
                    .data(pack(root).leaves())
                    .enter().append("g")
                    .attr("class", "node")
                    .attr("transform", function (d) {
                        return "translate(" + d.x + "," + d.y + ")";
                    });

                node.append("circle")
                    .attr("id", function (d) {
                        return d.id;
                    })
                    .attr("r", function (d) {
                        return d.r;
                    })
                    .style("fill", function (d) {
                        return color(d.id);
                    });

                node.append("clipPath")
                    .attr("id", function (d) {
                        return "clip-" + d.id;
                    })
                    .append("use")
                    .attr("xlink:href", function (d) {
                        return "#" + d.id;
                    });

                node.append("text")
                    .attr("clip-path", function (d) {
                        return "url(#clip-" + d.id + ")";
                    })
                    .selectAll("tspan")
                    .data(function (d) {
                        return d.id.split(/(?=[A-Z][^A-Z])/g);
                    })
                    .enter().append("tspan")
                    .attr("x", 0)
                    .attr("y", function (d, i, nodes) {
                        return 13 + (i - nodes.length / 2 - 0.5) * 10;
                    })
                    .text(function (d) {
                        return d;
                    });

                node.append("title")
                    .text(function (d) {
                        return d.id;// + "\n" + format(d.value);
                    });


            });
        }

        updateFacet('I', 'Category');
        updateFacet('>', 'Tag');

    }, false);
</script>


</html>