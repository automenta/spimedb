<html>

<head>
    <style>
        body {
            background-color: black;
            color: #ccc;
            font-family: monospace;
            margin: 0;
            padding: 0;
            display: inline;
        }

        body, input, select, button {
            font-size: 120%;
        }

        input {
            background-color: black;
            color: orange;
        }

        #in {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            border-top: 1px solid gray;
        }

        #in input {
            width: 80%;
            border: none;
            padding: 0.25em;
        }


        .box {
            min-width: 10em;
            min-height: 3em;
            max-height: 100%;
            max-width: 100%;
            background-color: #555;
            margin: 0.5em;
            padding: 0.5em;
            overflow-y: auto;

        }


        .box * {
            padding: 0.25em;
            margin: 0;
        }

        body .box  {
        }

        .box pre {
            background-color: #000;
            overflow: auto;
        }

        .group {
            display: inline;
            max-width: 100%;
        }

        .group .box {
            background-color: #333;
            font-size: 50%;
            margin: 0.5em;

        }

        .box .controls {
        }
        .controls .button {
            background-color: #1a0dab;
        }
        .controls .button:hover {
            background-color: #00a23f;
        }



    </style>
</head>


<script src="lib/lodash.js"></script>
<script src="lib/jquery.min.js"></script>
<script src="lib/msgpack.js"></script>
<script src="ReconnectingWebsocket.js"></script>
<!--<script src="../lib/web_socket.js"></script>-->

<script src="lib/leaflet/leaflet.js"></script>

<script src="util.js"></script>

<script src="lib/interact/interact.min.js"></script>

<link rel="stylesheet" href="windgets.css">
<script src="util.windget.js"></script>

<script src="spime.js"></script>

<body>

    <div id="in" >

        <span>
            <select id="inMode">
                <option value="find" selected>find</option>
                <option value="say">say</option>
            </select>
        </span>

        <span id="in_find" class="inner" >
        </span>
        <span id="in_say" class="inner" >
            <input type="text"/>
            <button>SEND</button>
        </span>

    </div>



</body>

<script>
    const map = null; /*MAP('map', (x)=>{
     //LOAD(x, 0.5);
     });*/

    $(() => {

        {
            $('.inner').hide();

            var shown = $('#in_find');
            shown.show();

            $('#inMode').change(function () {

                shown.hide();
                (shown = $('#in_' + this.value)).show();

            })
        }

        var Oo = $('body');

        function ADD(label, content) {

            const b = DIVclass('box');

            const controls = DIVclass('controls').append(
                SPANclass('label').append(label),
                SPANclass('button').text('~').click(()=>{
                    newWindow(b);
                }),
                SPANclass('button').text('x')
            );

            b.append( controls ).append( content );


            Oo.append(b);

            setTimeout(()=>{



              //scroll to bottom
              const height = document.body.scrollHeight;
              document.body.scrollTop = (height);
            },0);

            return b;
        }

        function ADD_QUERY() {

            const query = DIV();
            const suggestBox = DIV();
            const results = DIVclass('group');

            var suggested = { };

            function clearSuggestions() {
                if (suggestBox) {
                    suggestBox.html('');
                    suggested = { };
                }
            }

            const I = QueryPrompt(

                function(suggestions) {
                    var ss;

                    try {
                        ss = JSON.parse(suggestions);
                    } catch (e) {
                        ss = [];
                    }

                    if (ss.length === 0) {
                        //hard clear
                        clearSuggestions();
                        return;
                    } else if (suggestBox) {
                        //soft clear
                        suggestBox.html([]);
                        suggested = {};
                    }


                    _.forEach(ss, x => {
                        if (!suggested[x]) {
                            suggested[x] = suggestBox.append(divCls('box').append(x));
                        }
                    });
                },

                function(result) {

                    clearSuggestions();
                    results.html('');

                    var ss, rr, ff;
                    try {
                        ss = JSON.parse(result);
                        rr = ss[0]; //first part: search results
                        ff = ss[1]; //second part: facets
                    } catch (e) {
                        //usually just empty search result
                        //$('#results').html('No matches for: "' + qText + '"');
                        return;
                    }

                    var toAdd = [];
                    _.forEach(rr, x => {
                        if (!x.I) return;

                        //const score = x.score;
                        const y = new NObject(x);
                        if (y.what)
                            toAdd.push(y.what.addClass('box'));
                    });

                    if (toAdd.length > 0)
                        results.append(toAdd);

                }
            );

            query.append( suggestBox, results );

            return ADD(I, query);
        }

        function ADD_SAY() {

        }
        function ADD_COMMAND() {

        }

        function code(e) {
            return $('<pre>').text(JSON.stringify(e, null, 2));
        }



        //var I = $('#in');

        /*I.keyup(function(e) {
            if (e.keyCode == 13) {
                var x = I.val();
                I.val('');
                ws.send(x);
            }
        });*/






        const sayBox = $('#in_say input');
        sayBox.change(v=>{
            const msg = sayBox.val();
            if (msg.length > 0) {
                sayBox.val('');
                ws.send('me.tell([""], \"' + msg + '\")');
            }
        });

        const ws = new SpimeSocket('anon', (x)=>{
            if (typeof(m)!=='string') {
                m = newEle('pre').text(JSON.stringify(x, null, 2));
            }

            ADD( newEle('span').text(x.N || x.I), m );
        });
        ws.onopen = ()=>{
            ADD_QUERY();
        };

    });
</script>

</html>
